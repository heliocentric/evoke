#!/bin/sh
# $Id


echo -n "Verifying root filesystem					"
ROOTFINGERPRINT=$(kenv -q dsbsd.fingerprint)
if [ "${ROOTFINGERPRINT}" != "" ] ; then
	if [ "${ROOTFINGERPRINT}" != "$(sha256 -q /dev/md0)" ] ; then
		echo "[FAILED]"
		reboot
	fi
fi
echo "[DONE]"

echo -n "Merging /bin							"
OS=$(sysctl -n kern.ostype)
ABI=$(sysctl -n kern.osrelease | cut -d . -f 1)
export ARCH=$(sysctl -n hw.machine_arch)
export MACHINE=$(sysctl -n hw.machine)
if [ -d "/${OS}-${ABI}/${ARCH}/bin" ] ; then
	mount_nullfs -o union,ro /${OS}-${ABI}/${ARCH}/bin /bin
fi
mount_nullfs -o union,ro /share/bin/ /bin/
export PATH=/bin:/${OS}-${ABI}/${ARCH}/bin
echo "[DONE]"

echo -n "Remounting root filesystem R/W					"
mount -o update,rw /dev/md0 / 2>/dev/null >/dev/null
echo "[DONE]"

echo -n "Creating /tmp							"
mdmfs -s4m md /tmp
mkdir /tmp/lib
mount_nullfs -o union,ro /share/lib/ /etc/
mount_nullfs -o union,ro /tmp/lib/ /etc/
echo "[DONE]"

echo -n "Grabbing root password from loader.conf				"
RPASSWD=$(kenv -q dsbsd.rootpassword)
if [ "${RPASSWD}" = "" ] ; then
	echo "[FAILED]"
	echo -n "Setting password to 'password'					"
	RPASSWD='$1$1QgK4Xsg$.PInGIAb4c0nznxpRkUPk.'
	echo "[DONE]"
else
	echo "[DONE]"
fi

echo -n "Creating root account						"
echo "root:${RPASSWD}:0:0::0:0:Super-User:/:/bin/tcsh" >>/tmp/lib/master.passwd
pwd_mkdb -d /tmp/lib/ /tmp/lib/master.passwd 2>/dev/null
echo "[DONE]"

tcsh
reboot
