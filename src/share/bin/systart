#!/bin/sh
# $Id
ROOTFINGERPRINT=$(kenv -q boot.fingerprint)

echo -n "Verifying root filesystem ..... "
if [ "${ROOTFINGERPRINT}" != "" ] ; then
	if [ "${ROOTFINGERPRINT}" != "$(sha256 -q /dev/md0)" ] ; then
		echo "[FAILED]"
		reboot
	fi
fi
echo "[DONE]"

echo -n "Remounting root filesystem R/W ..... "
mount -o update,rw /dev/md0 / 2>/dev/null >/dev/null
echo "[DONE]"

echo -n "Grabbing root password from loader.conf ..... "
RPASSWD=$(kenv -q boot.rootpassword)
if [ "${RPASSWD}" = "" ] ; then
	echo "[FAILED]"
	echo -n "Setting password to 'password' ..... "
	RPASSWD='$1$1QgK4Xsg$.PInGIAb4c0nznxpRkUPk.'
	echo "[DONE]"
else
	echo "[DONE]"
fi

echo -n "Creating root account ..... "
echo "root:${RPASSWD}:0:0::0:0:Super-User:/:/bin/tcsh" >/etc/master.passwd
pwd_mkdb /etc/master.passwd
echo "[DONE]"

tcsh
reboot
